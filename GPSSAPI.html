<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIPO API 專利檢索測試</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { color: #333; border-left: 5px solid #007BFF; padding-left: 10px; }
        .input-group { margin: 20px 0; display: flex; flex-direction: column; gap: 10px; }
        input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        button { padding: 12px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; }
        button:hover { background-color: #218838; }
        #result-display { 
            margin-top: 20px;
            border: 1px dashed #bbb; 
            padding: 15px; 
            background-color: #272822; /* 深色背景模擬工程師界面 */
            color: #f8f8f2;
            min-height: 300px; 
            white-space: pre-wrap; 
            word-break: break-all;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
        }
        .status-msg { font-size: 14px; margin-bottom: 5px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>智慧財產局 API 檢索工具</h2>
    
    <div class="input-group">
        <label for="apiUrl">請輸入完整 API 網址：</label>
        <input type="text" id="apiUrl" value="https://tiponet.tipo.gov.tw/gpss1/gpsskmc/gpss_api?userCode=您的驗證碼&patDB=TWA,TWB&patAG=A,B&patTY=I&TI=太陽能&ID=20150101:20160101&expFld=PN,AN,ID,AD,TI&expFmt=json&expQty=100">
        <button id="sendBtn">開始獲取專利資料</button>
    </div>

    <div class="status-msg" id="statusMsg">等待指令...</div>
    <div id="result-display">回應結果將顯示於此...</div>
</div>

<script>
    const sendBtn = document.getElementById('sendBtn');
    const apiUrlInput = document.getElementById('apiUrl');
    const resultDisplay = document.getElementById('result-display');
    const statusMsg = document.getElementById('statusMsg');

sendBtn.addEventListener('click', async () => {
    const rawUrl = apiUrlInput.value.trim();
    if (!rawUrl) {
        alert('請輸入網址');
        return;
    }

    // --- 關鍵修改：使用 allorigins 公共代理服務 ---
    // 這會將您的請求包裝起來，由 allorigins 的伺服器代為發送
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(rawUrl)}`;

    statusMsg.textContent = '正在透過公共代理伺服器連線...';
    resultDisplay.textContent = '讀取中...';

// ... 前段 fetch 程式碼保持不變 ...

try {
    const response = await fetch(proxyUrl);
    if (!response.ok) throw new Error(`連線錯誤: ${response.status}`);

    const wrapperData = await response.json();
    
    // 如果您使用公共代理 allorigins，資料在 .contents 中，需先轉為物件
    const data = typeof wrapperData.contents === 'string' 
                 ? JSON.parse(wrapperData.contents) 
                 : wrapperData;

    // 1. 定義提取路徑 (使用可選鏈 ?. 確保程式不會因為欄位缺失而崩潰)
    const patentList = data['gpss-API']?.patent?.patentcontent;

    if (patentList && Array.isArray(patentList)) {
        // 2. 提取所有 doc-number
        const docNumbers = patentList.map(item => {
            return item['publication-reference']?.['doc-number'] || '無證號資料';
        });

        // 3. 顯示結果：將陣列轉為以換行分隔的字串
        statusMsg.textContent = `成功！共找到 ${docNumbers.length} 筆證號：`;
        resultDisplay.textContent = docNumbers.join('\n');
    } else {
        statusMsg.textContent = '查詢成功，但找不到專利內容。';
        resultDisplay.textContent = '回傳格式可能不包含專利清單。';
    }

} catch (error) {
    statusMsg.textContent = '解析資料失敗。';
    resultDisplay.textContent = '錯誤資訊：' + error.message;
}
});
</script>

</body>
</html>
